name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    name: Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration Release --no-restore

    - name: Publish Console Installer
      run: |
        dotnet publish src/ClaudeCodeInstaller.Console/ClaudeCodeInstaller.Console.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output ./artifacts/console `
          /p:PublishSingleFile=true `
          /p:PublishTrimmed=true

    - name: Publish WinForms Installer
      run: |
        dotnet publish src/ClaudeCodeInstaller.WinForms/ClaudeCodeInstaller.WinForms.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output ./artifacts/winforms `
          /p:PublishSingleFile=true

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-installers
        path: |
          artifacts/**/*.exe
        retention-days: 30

  test:
    name: Test
    runs-on: windows-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        files: '**/coverage.cobertura.xml'
        fail_ci_if_error: false

  version-tag:
    name: Create RC Version Tag and Release
    runs-on: windows-latest
    needs: [build, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from project
      id: get_version
      run: |
        $version = (Select-String -Path "src/ClaudeCodeInstaller.Core/ClaudeCodeInstaller.Core.csproj" -Pattern '<Version>([^<]+)</Version>').Matches.Groups[1].Value
        $rcTag = "v$version-rc.$(Get-Date -Format 'yyyyMMddHHmmss')"
        Write-Host "Version: $version"
        Write-Host "RC Tag: $rcTag"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$rcTag" >> $env:GITHUB_OUTPUT

    - name: Get previous tag
      id: previous_tag
      run: |
        $previousTag = git describe --tags --abbrev=0 HEAD^ 2>$null
        if ($LASTEXITCODE -ne 0) {
          $previousTag = ""
        }
        Write-Host "Previous tag: $previousTag"
        echo "tag=$previousTag" >> $env:GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        $previousTag = "${{ steps.previous_tag.outputs.tag }}"
        $currentTag = "${{ steps.get_version.outputs.tag }}"
        
        if ($previousTag -eq "") {
          Write-Host "No previous tag found, getting all commits"
          $commits = git log --pretty=format:"%s" HEAD
        } else {
          Write-Host "Getting commits since $previousTag"
          $commits = git log --pretty=format:"%s" ${previousTag}..HEAD
        }
        
        $changelog = "## Changelog`n`n"
        
        # Categorize commits by type
        $features = @()
        $fixes = @()
        $docs = @()
        $refactor = @()
        $other = @()
        
        foreach ($commit in $commits) {
          if ($commit -match '^feat(\(.+\))?: (.+)') {
            $features += "- $($matches[2])"
          } elseif ($commit -match '^fix(\(.+\))?: (.+)') {
            $fixes += "- $($matches[2])"
          } elseif ($commit -match '^docs(\(.+\))?: (.+)') {
            $docs += "- $($matches[2])"
          } elseif ($commit -match '^refactor(\(.+\))?: (.+)') {
            $refactor += "- $($matches[2])"
          } elseif ($commit -notmatch '^(chore|ci|build|test|style)') {
            $other += "- $commit"
          }
        }
        
        if ($features.Count -gt 0) {
          $changelog += "### ‚ú® Features`n"
          $changelog += ($features -join "`n") + "`n`n"
        }
        
        if ($fixes.Count -gt 0) {
          $changelog += "### üêõ Bug Fixes`n"
          $changelog += ($fixes -join "`n") + "`n`n"
        }
        
        if ($refactor.Count -gt 0) {
          $changelog += "### ‚ôªÔ∏è Refactoring`n"
          $changelog += ($refactor -join "`n") + "`n`n"
        }
        
        if ($docs.Count -gt 0) {
          $changelog += "### üìù Documentation`n"
          $changelog += ($docs -join "`n") + "`n`n"
        }
        
        if ($other.Count -gt 0) {
          $changelog += "### üì¶ Other Changes`n"
          $changelog += ($other -join "`n") + "`n`n"
        }
        
        if ($features.Count -eq 0 -and $fixes.Count -eq 0 -and $docs.Count -eq 0 -and $refactor.Count -eq 0 -and $other.Count -eq 0) {
          $changelog += "No significant changes since last release.`n`n"
        }
        
        $changelog += "---`n"
        $changelog += "**Full Changelog**: $previousTag...$currentTag"
        
        Write-Host "Generated changelog:"
        Write-Host $changelog
        echo "changelog<<EOF" >> $env:GITHUB_OUTPUT
        echo $changelog >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT

    - name: Create RC tag
      run: |
        $tag = "${{ steps.get_version.outputs.tag }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "$tag" -m "Release Candidate: $tag"
        git push origin "$tag"
        Write-Host "Created tag: $tag"

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-installers

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Release Candidate ${{ steps.get_version.outputs.tag }}
        body: |
          ${{ steps.changelog.outputs.changelog }}
          
          ## Downloads
          - **Console Installer**: ClaudeCodeInstaller.Console.exe
          - **WinForms Installer**: ClaudeCodeInstaller.WinForms.exe
        files: |
          artifacts/**/*.exe
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  healthcheck:
    name: Health Check
    runs-on: windows-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-installers

    - name: Run health check
      run: |
        Write-Host "Running health check..."
        if (Test-Path "artifacts/console/ClaudeCodeInstaller.Console.exe") {
          Write-Host "‚úì Console installer found"
        } else {
          Write-Host "‚úó Console installer not found"
          exit 1
        }
        if (Test-Path "artifacts/winforms/ClaudeCodeInstaller.WinForms.exe") {
          Write-Host "‚úì WinForms installer found"
        } else {
          Write-Host "‚úó WinForms installer not found"
          exit 1
        }
        Write-Host "Health check passed!"
